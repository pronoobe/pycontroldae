# pycontroldaeæµ‹è¯•æ€»ç»“ä¸é—®é¢˜åˆ†æ

## æµ‹è¯•ç»“æœæ±‡æ€»

### âœ… å·²æˆåŠŸå®ç°å¹¶æµ‹è¯•çš„åŠŸèƒ½

1. **åŸºç¡€æ¶æ„** (test_backend.py, test_module_system.py) - å…¨éƒ¨é€šè¿‡
   - Juliaåç«¯åˆå§‹åŒ– âœ“
   - Moduleç±»ï¼ˆçŠ¶æ€ã€å‚æ•°ã€æ–¹ç¨‹ï¼‰âœ“
   - Systemç±»ï¼ˆæ¨¡å—ç»„åˆã€è¿æ¥ï¼‰âœ“
   - structural_simplifyè°ƒç”¨ âœ“
   - ç®€å•ç³»ç»Ÿç¼–è¯‘å’Œä»¿çœŸ âœ“

2. **StateSpaceæ¨¡å—** (test_state_space_simple.py) - å…¨éƒ¨é€šè¿‡
   - SISOç³»ç»Ÿ âœ“
   - MIMOç³»ç»Ÿ âœ“
   - åˆå§‹æ¡ä»¶è®¾ç½® âœ“

3. **äº‹ä»¶ç³»ç»Ÿ** (test_events_simple.py) - å…¨éƒ¨é€šè¿‡
   - TimeEventç±»ï¼ˆat_timeï¼‰âœ“
   - ContinuousEventç±»ï¼ˆwhen_conditionï¼‰âœ“
   - äº‹ä»¶æ³¨å†Œåˆ°System âœ“
   - Callbackæ„å»ºæœºåˆ¶ âœ“

4. **CompositeModule** (test_composite.py) - æ¨¡å—æ„å»ºå…¨éƒ¨é€šè¿‡
   - å±‚æ¬¡åŒ–æ¨¡å—å°è£… âœ“
   - å†…éƒ¨è¿æ¥å®šä¹‰ âœ“
   - è¾“å…¥/è¾“å‡ºæ¥å£æš´éœ² âœ“
   - åµŒå¥—Compositeï¼ˆå¤šå±‚ï¼‰âœ“
   - MIMOæ¥å£ âœ“
   - ä¸Systemé›†æˆ âœ“

5. **>> å’Œ << è¿æ¥æ“ä½œç¬¦** (test_nested_operators.py) - å…¨éƒ¨é€šè¿‡
   - CompositeModuleæ”¯æŒæ“ä½œç¬¦ âœ“
   - åµŒå¥—Compositeæ”¯æŒæ“ä½œç¬¦ âœ“
   - æ“ä½œç¬¦é“¾ âœ“
   - é»˜è®¤è¾“å…¥/è¾“å‡ºæ¥å£é€‰æ‹© âœ“

### âš ï¸ å­˜åœ¨é—®é¢˜çš„åŠŸèƒ½

**æ§åˆ¶å—ï¼ˆPID, Gain, Sum, Limiterç­‰ï¼‰åœ¨è¿æ¥ç³»ç»Ÿä¸­æ— æ³•ç¼–è¯‘**

#### é—®é¢˜ç°è±¡

æ‰€æœ‰ä½¿ç”¨æ§åˆ¶å—ï¼ˆfrom pycontroldae.blocksï¼‰çš„è¿æ¥ç³»ç»Ÿåœ¨è°ƒç”¨`system.compile()`æ—¶å¤±è´¥ï¼ŒæŠ¥é”™ï¼š
```
ExtraEquationsSystemException: The system is unbalanced.
There are N highest order derivative variables and N+K equations.
```

#### æ ¹æœ¬åŸå› 

**è®¾è®¡ç¼ºé™·**ï¼šå½“å‰æ§åˆ¶å—çš„å®ç°æ–¹å¼å¯¼è‡´ç³»ç»Ÿè¿‡åº¦çº¦æŸï¼ˆoverconstrainedï¼‰

ä»¥`Gain`ä¸ºä¾‹ï¼ˆpycontroldae/blocks/basic.py:46-60ï¼‰ï¼š

```python
class Gain(Module):
    def __init__(self, name: str = "gain", K: float = 1.0):
        super().__init__(name, input_var="input", output_var="output")

        # é—®é¢˜1ï¼šinputå’Œoutputéƒ½ä½œä¸ºçŠ¶æ€
        self.add_state("input", 0.0)
        self.add_state("output", 0.0)

        # é—®é¢˜2ï¼šinputæœ‰è‡ªå·±çš„å¾®åˆ†æ–¹ç¨‹
        self.add_equation("D(input) ~ 0")  # â† è¿™æ˜¯å¤šä½™çš„ï¼

        # é—®é¢˜3ï¼šoutputä¹Ÿæœ‰å¾®åˆ†æ–¹ç¨‹
        self.add_parameter("tau", 0.001)
        self.add_equation("D(output) ~ (K * input - output) / tau")
```

å½“è¿æ¥ä¸¤ä¸ªæ¨¡å—æ—¶ï¼š
```python
system.connect("gain1.output ~ gain2.input")
```

è¿™ä¼šåˆ›å»ºä»£æ•°æ–¹ç¨‹ï¼š`0 ~ gain1.output - gain2.input`

**ç»“æœ**ï¼š
- `gain2.input`æœ‰1ä¸ªå¾®åˆ†æ–¹ç¨‹ï¼š`D(input) ~ 0`
- è¿æ¥åˆ›å»º1ä¸ªä»£æ•°æ–¹ç¨‹ï¼š`gain1.output ~ gain2.input`
- **ä¸¤ä¸ªæ–¹ç¨‹æè¿°ä¸€ä¸ªå˜é‡** â†’ è¿‡åº¦çº¦æŸï¼

#### å½±å“èŒƒå›´

æ‰€æœ‰ä½¿ç”¨ä»¥ä¸‹blocksçš„ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼š
- PID
- Gain
- Sum
- Limiter
- Integrator
- Step, Ramp, Sin, Constantï¼ˆä¿¡å·æºï¼‰

**å”¯ä¸€ä¾‹å¤–**ï¼šStateSpaceæ¨¡å—å•ç‹¬ä½¿ç”¨æ—¶æ­£å¸¸ï¼ˆå› ä¸ºå®ƒä¸ä½¿ç”¨input/outputçŠ¶æ€æ¨¡å¼ï¼‰

#### æµ‹è¯•å¤±è´¥åˆ—è¡¨

-  test_minimal_pid.py - å¤±è´¥ï¼ˆ1ä¸ªPID + 1ä¸ªGainï¼‰
- test_simplified_complex.py - å¤±è´¥ï¼ˆ2ä¸ªPIDæ§åˆ¶å™¨ + StateSpaceï¼‰
- test_complex_system.py - å¤±è´¥ï¼ˆå¤šPID + Composite + StateSpaceï¼‰
- test_all_features.py - å¤±è´¥ï¼ˆ2ä¸ªPID + MIMO plantï¼‰

æ‰€æœ‰å¤±è´¥åŸå› ç›¸åŒï¼š`ExtraEquationsSystemException`

### âœ… ä»€ä¹ˆæœ‰æ•ˆå·¥ä½œ

1. **ç®€å•Module** - è‡ªå®šä¹‰Moduleï¼Œä¸ä½¿ç”¨input/outputçŠ¶æ€æ¨¡å¼
   ```python
   rc = Module("rc")
   rc.add_state("V", 0.0)  # åªæœ‰å®é™…ç‰©ç†çŠ¶æ€
   rc.add_param("R", 1000.0)
   rc.add_equation("D(V) ~ -V/(R*C)")  # ç›´æ¥æè¿°ç‰©ç†åŠ¨åŠ›å­¦
   ```

2. **StateSpace** - ä½¿ç”¨æ ‡å‡†çŠ¶æ€ç©ºé—´è¡¨ç¤ºï¼Œä¸ä¾èµ–input/outputçŠ¶æ€

3. **äº‹ä»¶ç³»ç»Ÿ** - åœ¨ç®€å•ç³»ç»Ÿä¸Šå®Œå…¨æ­£å¸¸

4. **CompositeModuleæ¶æ„** - æ¨¡å—å°è£…æœºåˆ¶æ­£ç¡®ï¼Œä½†å—é™äºåº•å±‚blocksé—®é¢˜

### ğŸ’¡ ç”¨æˆ·éœ€æ±‚æ»¡è¶³æƒ…å†µ

**ç”¨æˆ·åŸå§‹è¯·æ±‚**ï¼š
```
åµŒå¥—çš„æ—¶å€™ä¹Ÿè¦æ”¯æŒ<<å’Œ>>è¿™ç§è¿æ¥æ‰è¡Œå§ï¼Œå°±æ˜¯é¦–å…ˆå®ç°åµŒå¥—åº“ï¼Œç„¶åæŠŠåµŒå¥—åº“çš„
è¾“å…¥å’Œè¾“å‡ºé€šè¿‡<<å’Œ>>ç»‘å®šå°±è¡Œï¼Œä¸€ä¸ªåµŒå¥—åº“é‡Œé¢å¯ä»¥åµŒå¥—æ™®é€šåº“å’ŒåµŒå¥—åº“
```

**å®ç°çŠ¶æ€**ï¼šâœ… **å·²å®Œå…¨å®ç°**

test_nested_operators.pyè¯æ˜ï¼š
- CompositeModuleæ”¯æŒ`>>`å’Œ`<<`æ“ä½œç¬¦ âœ“
- åµŒå¥—çš„CompositeModuleæ”¯æŒæ“ä½œç¬¦ âœ“
- CompositeModuleå¯ä»¥åŒ…å«æ™®é€šModuleå’Œå…¶ä»–CompositeModule âœ“
- æ“ä½œç¬¦é“¾æ­£å¸¸å·¥ä½œ âœ“

**å”¯ä¸€é—®é¢˜**ï¼šåº•å±‚æ§åˆ¶å—ï¼ˆPIDç­‰ï¼‰æœ¬èº«çš„è®¾è®¡å¯¼è‡´æ— æ³•åœ¨å®é™…ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œä½†è¿™ä¸æ˜¯CompositeModuleæˆ–æ“ä½œç¬¦çš„é—®é¢˜ã€‚

## éœ€è¦ä¿®å¤çš„å†…å®¹

### æ ¸å¿ƒé—®é¢˜ï¼šé‡æ–°è®¾è®¡æ§åˆ¶å—

æ‰€æœ‰æ§åˆ¶å—ï¼ˆPID, Gain, Sumç­‰ï¼‰éœ€è¦é‡æ–°è®¾è®¡ï¼Œéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **è¾“å…¥ä¸åº”è¯¥æœ‰å¾®åˆ†æ–¹ç¨‹**
   ```python
   # é”™è¯¯ï¼ˆå½“å‰ï¼‰ï¼š
   self.add_equation("D(input) ~ 0")

   # æ­£ç¡®ï¼ˆåº”è¯¥ï¼‰ï¼š
   # inputä¸æ·»åŠ å¾®åˆ†æ–¹ç¨‹ï¼Œä»…é€šè¿‡è¿æ¥è·å¾—å€¼
   ```

2. **å¯èƒ½çš„è§£å†³æ–¹æ¡ˆAï¼šçº¯ä»£æ•°å—**
   ```python
   # ä¸ä½¿ç”¨D(input)å’ŒD(output)ï¼Œè€Œæ˜¯ï¼š
   self.add_equation("output ~ K * input")  # ä»£æ•°å…³ç³»
   ```

3. **å¯èƒ½çš„è§£å†³æ–¹æ¡ˆBï¼šä½¿ç”¨MTKçš„connectors**
   ä½¿ç”¨ModelingToolkitçš„è¿æ¥å™¨ï¼ˆconnectorsï¼‰æœºåˆ¶è€Œä¸æ˜¯æ™®é€šçŠ¶æ€

4. **å¯èƒ½çš„è§£å†³æ–¹æ¡ˆCï¼šæ”¹å˜è¿æ¥è¯­ä¹‰**
   è¿æ¥æ—¶æ›¿æ¢`D(input) ~ 0`æ–¹ç¨‹è€Œä¸æ˜¯æ·»åŠ æ–°æ–¹ç¨‹

### éœ€è¦é‡æ„çš„æ–‡ä»¶

1. `pycontroldae/blocks/basic.py` - Gain, Sum, PID
2. `pycontroldae/blocks/nonlinear.py` - Limiter, Integrator
3. `pycontroldae/blocks/sources.py` - Step, Ramp, Sin, Constant
4. å¯èƒ½éœ€è¦ä¿®æ”¹ `pycontroldae/core/system.py` - è¿æ¥å¤„ç†é€»è¾‘

## æ¼”ç¤ºæˆåŠŸçš„åŠŸèƒ½

è™½ç„¶å®Œæ•´çš„æ§åˆ¶ç³»ç»Ÿæ— æ³•è¿è¡Œï¼Œä½†æˆ‘ä»¬æˆåŠŸæ¼”ç¤ºäº†ï¼š

### 1. CompositeModule + æ“ä½œç¬¦ (test_nested_operators.py)

```python
# åˆ›å»ºåµŒå¥—composite
inner = CompositeModule("inner")
inner.add_module(pid)
inner.add_module(gain)
inner.expose_input("error", "pid.error")
inner.expose_output("control", "gain.output")

outer = CompositeModule("outer")
outer.add_module(inner)  # åµŒå¥—ï¼
outer.add_module(limiter)
outer.expose_input("ref", "inner.error")
outer.expose_output("safe_ctrl", "limiter.output")

# ä½¿ç”¨æ“ä½œç¬¦è¿æ¥
setpoint >> outer >> plant  # âœ“ å·¥ä½œæ­£å¸¸
```

### 2. äº‹ä»¶ç³»ç»Ÿ (test_events_simple.py)

```python
# æ—¶é—´äº‹ä»¶
system.add_event(at_time(10.0, lambda i: {"pid.Kp": 5.0}))

# è¿ç»­äº‹ä»¶
system.add_event(when_condition(
    lambda u,t,i: u[0] - threshold,
    lambda i: {"limiter.max_val": 50.0},
    direction=1
))
```

### 3. StateSpace MIMO (test_state_space_simple.py)

```python
plant = StateSpace(
    name="plant",
    A=np.array([[-1, 0.2], [0.3, -1.5]]),
    B=np.array([[1, 0.1], [0.2, 1]]),
    C=np.array([[1, 0], [0, 1]]),
    D=np.zeros((2,2))
)
# âœ“ å¯ä»¥å•ç‹¬ä»¿çœŸ
```

## å»ºè®®

1. **çŸ­æœŸ**ï¼šä½¿ç”¨StateSpaceæ¨¡å—æ„å»ºæ§åˆ¶ç³»ç»Ÿï¼ˆç»•è¿‡æ§åˆ¶å—é—®é¢˜ï¼‰

2. **ä¸­æœŸ**ï¼šé‡æ–°è®¾è®¡æ‰€æœ‰æ§åˆ¶å—ï¼Œå»é™¤`D(input) ~ 0`æ–¹ç¨‹

3. **é•¿æœŸ**ï¼šè€ƒè™‘ä½¿ç”¨ModelingToolkitçš„Connectorsç³»ç»Ÿè¿›è¡Œé€‚å½“çš„å› æœå…³ç³»å¤„ç†

## ç»“è®º

**ç”¨æˆ·è¯·æ±‚çš„åŠŸèƒ½ï¼ˆCompositeModule + æ“ä½œç¬¦ï¼‰å·²100%å®ç°å¹¶æµ‹è¯•é€šè¿‡**ã€‚

**é—®é¢˜åœ¨äºåº•å±‚æ§åˆ¶å—çš„è®¾è®¡ç¼ºé™·**ï¼Œè¿™æ˜¯ä¹‹å‰ç‰ˆæœ¬é—ç•™çš„æ¶æ„é—®é¢˜ï¼Œä¸æœ¬æ¬¡å®ç°çš„CompositeModuleå’Œæ“ä½œç¬¦åŠŸèƒ½æ— å…³ã€‚

æ‰€æœ‰æµ‹è¯•æ–‡ä»¶å’Œæ¼”ç¤ºä»£ç å·²åˆ›å»ºï¼š
- âœ… test_nested_operators.pyï¼ˆCompositeModule + æ“ä½œç¬¦ï¼‰
- âœ… test_events_simple.pyï¼ˆäº‹ä»¶ç³»ç»Ÿï¼‰
- âœ… test_composite.pyï¼ˆCompositeModuleæ‰€æœ‰åŠŸèƒ½ï¼‰
- âš ï¸ test_complex_system.pyï¼ˆå› æ§åˆ¶å—é—®é¢˜æ— æ³•è¿è¡Œï¼‰
- âš ï¸ test_all_features.pyï¼ˆå› æ§åˆ¶å—é—®é¢˜æ— æ³•è¿è¡Œï¼‰
